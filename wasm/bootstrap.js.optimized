(function(){'use strict';
const LOG_PREFIX="LoaderBootstrap: ";
const BASE64_LOOKUP=createBase64Lookup();

function createBase64Lookup(){
  const lookup=[];
  for(let i=0;i<64;i++)lookup["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(i)]=i;
  lookup[45]=62;lookup[95]=63;return lookup;
}

function g(a){console.log(LOG_PREFIX+"[INFO] "+a)}
function n(a){console.log(LOG_PREFIX+"[WARN] "+a)}
function q(a){console.error(LOG_PREFIX+"[ERROR] "+a)}

function u(b,d){
  const lookup=BASE64_LOOKUP;
  let e=b.length-d;
  if(e%4!==0)throw Error("Invalid string. Length must be a multiple of 4");
  let f=b.indexOf("=",d);
  f=f===-1?e:f-d;
  const parts=[f,f===e?0:4-f%4];
  let l=parts[0];e=parts[1];
  const result=new Uint8Array(3*(l+e)/4-e);
  let h=0;l=(e>0?l-4:l)+d;
  for(let k=d;k<l;k+=4){
    const d=lookup[b.charCodeAt(k)]<<18|lookup[b.charCodeAt(k+1)]<<12|lookup[b.charCodeAt(k+2)]<<6|lookup[b.charCodeAt(k+3)];
    result[h++]=d>>16&255;result[h++]=d>>8&255;result[h++]=d&255;
  }
  if(e===2){const d=lookup[b.charCodeAt(l)]<<2|lookup[b.charCodeAt(l+1)]>>4;result[h++]=d&255;}
  else if(e===1){const d=lookup[b.charCodeAt(l)]<<10|lookup[b.charCodeAt(l+1)]<<4|lookup[b.charCodeAt(l+2)]>>2;result[h++]=d>>8&255;result[h++]=d&255;}
  return result.buffer;
}

function w(a){
  return new Promise(function(c){
    const b=new Image;
    b.onload=c;
    b.onerror=function(){n("Failed to preload image: "+a);c();};
    b.src=a;
  });
}

function x(a){
  return fetch(a,{cache:"force-cache"}).then(function(b){return b.arrayBuffer();}).catch(function(b){q("Failed to fetch URL! "+b);return null;});
}

function y(a){
  if(a.startsWith("data:application/octet-stream;base64,")){
    try{return u(a,37);}catch(e){q("Failed to decode base64! "+e);return null;}
  }else{return x(a);}
}

function z(a,c){
  const b=document.createElement("h2");
  b.style.color="#AA0000";b.style.padding="25px";b.style.fontFamily="sans-serif";b.style.marginBlock="0px";
  b.appendChild(document.createTextNode(c));a.appendChild(b);
  const d=document.createElement("h4");
  d.style.color="#AA0000";d.style.padding="25px";d.style.fontFamily="sans-serif";d.style.marginBlock="0px";
  d.appendChild(document.createTextNode("Try again later"));a.style.backgroundColor="white";a.appendChild(d);
}

window.main=async function(){
  if(typeof window.eaglercraftXOpts==="undefined"){q("window.eaglercraftXOpts is not defined!");alert("window.eaglercraftXOpts is not defined!");return;}
  let a=window.eaglercraftXOpts.container;
  if(typeof a!=="string"){q("window.eaglercraftXOpts.container is not a string!");alert("window.eaglercraftXOpts.container is not a string!");return;}
  let c=window.eaglercraftXOpts.assetsURI;
  if(typeof c!=="string"){
    if(typeof c==="object"&&typeof c[0]==="object"&&typeof c[0].url==="string")c=c[0].url;
    else{q("window.eaglercraftXOpts.assetsURI is not a string!");alert("window.eaglercraftXOpts.assetsURI is not a string!");return;}
  }
  if(c.startsWith("data:"))delete window.eaglercraftXOpts.assetsURI;
  let b=document.getElementById(a);
  if(!b){q('window.eaglercraftXOpts.container "'+a+'" is not a known element id!');alert('window.eaglercraftXOpts.container "'+a+'" is not a known element id!');return;}
  while(b.lastChild)b.removeChild(b.lastChild);
  let container=document.createElement("div");
  container.style.width="100%";container.style.height="100%";container.style.setProperty("image-rendering","pixelated");
  container.style.background='center / contain no-repeat url("data:image/png;base64,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") white';
  b.appendChild(container);
  g('Downloading EPW file "'+c+'"...');
  const epwData=await y(c);
  if(!epwData){z(b,"Failed to download EPW file!");q("Failed to download EPW file!");return;}
  if(epwData.byteLength<384){q("The EPW file is too short");z(b,"Failed to download EPW file!");q("Failed to download EPW file!");return;}
  const dv=new DataView(epwData);
  if(dv.getUint32(0,true)!==608649541||dv.getUint32(4,true)!==1297301847){q("The file is not an EPW file");z(b,"EPW file is invalid!");return;}
  const epwLen=epwData.byteLength;
  if(dv.getUint32(8,true)!==epwLen){q("The EPW file is the wrong length");z(b,"EPW file is invalid!");return;}
  const splashOff=dv.getUint32(100,true),splashLen=dv.getUint32(104,true),assetOff=dv.getUint32(108,true),assetLen=dv.getUint32(112,true);
  if(splashOff<0||splashOff+splashLen>epwLen||assetOff<0||assetOff+assetLen>epwLen){q("The EPW file contains an invalid offset");z(b,"EPW file is invalid!");return;}
  const splashData=new Uint8Array(epwData,splashOff,splashLen),assetData=new Uint8Array(epwData,assetOff,assetLen),splashMimeStr=new TextDecoder("utf-8").decode(assetData),splashURL=URL.createObjectURL(new Blob([splashData],{type:splashMimeStr}));
  await w(splashURL);
  g("Loaded splash img: "+splashURL);
  container.style.background='center / contain no-repeat url("'+splashURL+'"), 0px 0px / 1000000% 1000000% no-repeat url("'+splashURL+'") white';
  const loaderOff=dv.getUint32(164,true),loaderLen=dv.getUint32(168,true),wasmOff=dv.getUint32(180,true),wasmLen=dv.getUint32(184,true);
  if(loaderOff<0||loaderOff+loaderLen>epwLen||wasmOff<0||wasmOff+wasmLen>epwLen){q("The EPW file contains an invalid offset");z(b,"EPW file is invalid!");return;}
  const loaderData=new Uint8Array(epwData,loaderOff,loaderLen),loaderURL=URL.createObjectURL(new Blob([loaderData],{type:"text/javascript;charset=utf-8"})),wasmData=new Uint8Array(epwData,wasmOff,wasmLen),wasmURL=URL.createObjectURL(new Blob([wasmData],{type:"application/wasm"}));
  g("Loaded loader.js: "+loaderURL);
  g("Loaded loader.wasm: "+wasmURL);
  const ctx={};
  for(const [k,v] of Object.entries(window.eaglercraftXOpts)){if(k!=="container"&&k!=="assetsURI")ctx[k]=v;}
  window.__eaglercraftXLoaderContextPre={rootElement:b,eaglercraftXOpts:ctx,theEPWFileBuffer:epwData,loaderWASMURL:wasmURL,splashURL:splashURL};
  g("Appending loader.js to document...");
  const script=document.createElement("script");
  script.type="text/javascript";
  script.src=loaderURL;
  document.head.appendChild(script);
};
}).call(this);
